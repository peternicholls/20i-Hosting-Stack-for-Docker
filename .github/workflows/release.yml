name: Release

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 2.0.0 or 2.0.0-alpha.1)"
        required: false
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        type: boolean
        default: false

permissions:
    contents: write
    pull-requests: write
    id-token: write

concurrency:
    group: release-${{ github.ref }}
    cancel-in-progress: false

jobs:
    release-please:
        runs-on: ubuntu-latest
        outputs:
            release_created: ${{ steps.release.outputs.release_created }}
            tag_name: ${{ steps.release.outputs.tag_name }}
            version: ${{ steps.release.outputs.version }}
            upload_url: ${{ steps.release.outputs.upload_url }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Make validation scripts executable
              run: chmod +x scripts/release/validate.sh scripts/release/version.sh

            - name: Pre-release validation
              if: github.event_name == 'push'
              run: |
                  echo "üîç Running pre-release validation..."
                  scripts/release/validate.sh --all || {
                    echo "‚ùå Validation failed. Release will not proceed."
                    exit 1
                  }

            - name: Run release-please
              id: release
              uses: googleapis/release-please-action@v4
              with:
                  release-type: simple
                  config-file: release-please-config.json
                  manifest-file: .release-please-manifest.json
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Release summary
              if: steps.release.outputs.release_created == 'true'
              run: |
                  echo "‚úÖ Release created successfully!"
                  echo "üì¶ Version: ${{ steps.release.outputs.version }}"
                  echo "üè∑Ô∏è  Tag: ${{ steps.release.outputs.tag_name }}"
                  echo "üîó Release URL: ${{ steps.release.outputs.html_url }}"

    build-artifacts:
        needs: release-please
        if: needs.release-please.outputs.release_created == 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Make artifacts script executable
              run: chmod +x scripts/release/artifacts.sh

            - name: Build release artifacts
              run: scripts/release/artifacts.sh ${{ needs.release-please.outputs.version }}

            - name: Upload release artifacts
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ needs.release-please.outputs.tag_name }}
                  files: |
                      dist/20i-stack-*.tar.gz
                      dist/install.sh
                      dist/checksums.sha256
